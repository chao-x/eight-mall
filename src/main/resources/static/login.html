<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml">

<head>
    <meta charset="UTF-8">
    <title>登录</title>
    <script src="js/vue.js"></script>
    <script src="js/axios.min.js"></script>
    <script src="element-ui/index.js"></script>
    <script src="components/header_login/header_login.js"></script>
    <script src="components/header_login/footer_login.js"></script>
    <script src="js/common.js"></script>
    <link rel="stylesheet" type="text/css" href="element-ui/index.css">
    <link rel="stylesheet" type="text/css" href="components/header_login/header_login.css">
    <link rel="stylesheet" type="text/css" href="components/header_login/footer_login.css">
    <link rel="stylesheet" type="text/css" href="css/login.css">
</head>

<body style="height: 100%;padding: 0px;margin: 0">
    <div id="app" style="height: 100%;padding: 0px;margin: 0">
        <header_login></header_login>
        <div class="mall_login_root">
            <div class="mall_login_container">
                <div class="mall_login_Title">
                    <span>第八组商城登录</span>
                </div>
                <div style="text-align: center">
                    <div class="mall_login_leftside">
                        <div class="imgbox">
                            <img style="display: block;" src="images/QRcode.png">
                        </div>
                        <div class="qrcode_desc">
                            <span class="mall_login_text">
                                <span>请打开手机扫描二维码</span>
                            </span>
                        </div>
                    </div>
                    <span class="fullpage_split_line"></span>
                    <div class="mall_login_rightside">
                        <div class="mall_login_form">
                            <div class="mall_login_error_container" :class="{errorAccount: isError==true}">
                                <div class="mall_login_error">
                                    <span>您输入的账号密码有误</span>
                                </div>
                            </div>
                            <div class="mall_login_form_account_container">
                                <div class="input_border">
                                    <div class="input_wrap">
                                        <input v-on:input="ChangeOpacity" type="text" autocomplete="off" maxlength="150"
                                            placeholder="用户名/手机号" v-model="account" class="account_input">
                                    </div>
                                </div>
                            </div>
                            <div class="mall_login_form_password_container">
                                <div>
                                    <div class="input_border">
                                        <div class="input_wrap">
                                            <input v-on:input="ChangeOpacity" type="text" autocomplete="off"
                                                maxlength="150" placeholder="密码" v-model="password"
                                                class="password_input">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mall_login_form_button_container">
                                <div class="button_border">
                                    <div class="button_wrap" :class="{lighted: isEmpty==false}" v-on:click="Login">
                                        <span>登录</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mall_login_form_full_link">
                            <span class="loginpage_linkl" v-on:click="gotoRegister"><span class="link_text_container"><span>注册</span></span></span>
                            <span class="loginpage_link" v-on:click="gotoResetPassword"><span class="link_text_container"><span>忘记密码</span></span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer_login></footer_login>
    </div>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    account: "",
                    password: "",
                    isEmpty: true, //判断输入框为空
                    isError: false, //判断输入账号是否正确
                };
            },
            methods: {
                gotoRegister(){
                    window.location.href = "/register.html";
                },
                gotoResetPassword(){
                    window.location.href = "/resetPassword.html";
                },
                //判断输入框内是否为空，并以此作为依据更改登录按钮的透明度
                ChangeOpacity() {
                    if (this.account != "" && this.password != "") {
                        this.isEmpty = false;
                    } else {
                        this.isEmpty = true;
                    }
                },
                Login() {
                    if (this.account == "" && this.password == "") {
                        this.isError = true;
                    } else {
                        var data = {
                            "account": this.account,
                            "password": this.password,
                        }
                        axios.post('/actionmall/user/do_login.do', data).then(res => {
                            var resultdata = res.data;
                            if (resultdata.status == 0) {
                                if (resultdata.data.role == 1) {
                                    this.$message({
                                        message: "登录成功",
                                        type: "success"
                                    });
                                    setTimeout(() => {
                                        window.location.href = "/admin/commodity.html";
                                    }, 2000);
                                } else {
                                    this.$message({
                                        message: "登录成功",
                                        type: "success"
                                    });
                                    localStorage.setItem("user", JSON.stringify(resultdata.data));
                                    this.updateCart(resultdata.data)
                                    setTimeout(() => {
                                        //window.location.href = "/userCenter.html";
                                        //返回上一页并刷新
                                        let tag = getSearch(window.location.href, 'tag')
                                        if (self.location.href != document.referrer && tag!="1") {
                                            self.location.href = document.referrer
                                        }else {
                                            window.location.href = "/index.html";
                                        }
                                    }, 2000);
                                }
                            } else {
                                this.isError = true;
                            }
                        })
                    }
                },
                //处理缓存的购物车数据
                async updateCart(user) {
                    let saveCartUrl = "/actionmall/cart/savecart.do",
                        updateCartUrl = "/actionmall/cart/updatecarts.do",
                        getCartUrl = "/actionmall/cart/findallcarts.do"
                    //获取已有的购物车数据
                    let res = await this.post(getCartUrl)
                    //console.log(res)
                    if (res.data.status == 0) {
                        let cart = res.data.data.lists
                        console.log("userCart", cart)
                        //获取缓存的cartItems
                        let cartItems = JSON.parse(localStorage.getItem('cartItems'))
                        console.log(cartItems, user)
                        if (cartItems != null) {
                            //合并数据库数据和session数据
                            for (var j in cartItems) {
                                let repeat = false
                                for (var i in cart) {
                                    //重复，更新
                                    console.log(j, i, cartItems[j], cart[i])
                                    if (cartItems[j].productId == cart[i].productId) {
                                        repeat = true
                                        cart[i].quantity += cartItems[j].quantity
                                        //发送更新请求
                                        const data = {
                                            'userId': user.id,
                                            'productId': cart[i].productId,
                                            'quantity': cart[i].quantity
                                        }
                                        let resU = await this.post(updateCartUrl, data)
                                        if (resU.data.status == 0) {
                                            console.log(resU.data.data)
                                        } else {
                                            this.$message.err(resU.data.msg)
                                        }
                                        break;
                                    }
                                }
                                //不重复，合并
                                if (!repeat) {
                                    //发送新增请求
                                    const data = {
                                        'userId': user.id,
                                        'productId': cartItems[j].productId,
                                        'quantity': cartItems[j].quantity
                                    }
                                    let resS = await this.post(saveCartUrl, data)
                                    if (resS.data.status == 0) {
                                        console.log(resS.data.data)
                                    } else {
                                        this.$message.err(resS.data.msg)
                                    }
                                }
                            }
                            //删除购物车缓存
                            localStorage.removeItem('cartItems')
                        }
                    } else {
                        this.$message.err(res.data.msg)
                    }

                },
                //封装axios的post方法
                post(url, data) {
                    return new Promise((resolve, reject) => {
                        axios.post(url, data).then(res => {
                            if (res.data.status == 0) {
                                resolve(res)
                            } else {
                                reject(res.data.msg)
                            }
                        }, err => {
                            reject(err)
                        })
                    })
                }
            }
        })
    </script>
</body>

</html>